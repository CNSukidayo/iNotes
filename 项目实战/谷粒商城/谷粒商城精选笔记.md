# 目录: 
1. OSS对象存储服务  
2. Java校验  



## 1.OSS对象存储服务  
**目录:**  
1.1 使用SpringCloudAlibabaOSS对象存储服务组件  
1.2 浏览器/客户端直接提交文件  
1.3 配置跨域访问  

### 1.1使用SpringCloudAlibabaOSS对象存储服务组件  
**介绍:** 之前我们在尚尚优选项目中使用的是自已手动构建OSSClient对象,比较麻烦,通过使用SpringCloudAlibabaOSS组件来帮助我们使用阿里云的OSS服务.  

1.访问[SpringCloud-Alibaba官方网站](https://github.com/alibaba/spring-cloud-alibaba).找到OSS的项目示例.
> Examples
> > [Alibaba Cloud OSS Example](https://github.com/alibaba/aliyun-spring-boot/tree/master/aliyun-spring-boot-samples/aliyun-oss-spring-boot-sample)  

2.按照文档的操作步骤,先导入starter...
```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>aliyun-oss-spring-boot-starter</artifactId>
</dependency>
```

3.在需要使用该组件的模块的配置文件application.yml中配置相关的内容.  
```properties
// application.properties
alibaba.cloud.access-key=your-ak
alibaba.cloud.secret-key=your-sk
alibaba.cloud.oss.endpoint=***
```

4.直接在项目中依赖注入OSSClient对象.  

### 1.2 浏览器/客户端直接提交文件  
**问题描述:** 目前存在的问题是,浏览器每次上传一个文件,都需要服务器做一个中间的转换操作,十分浪费性能.现在的想法是能不能直接让浏览器去访问阿里云的OSS服务器,直接在客户端完成上传的操作?

**解决思路:** 客户端需要上传文件时,先从我们的服务器拿到一个policy,也可以认为其是一次性session,浏览器拿到这个session后就可以直接利用该session上传文件到OSS服务器.  
![policy](resourcesSelected/1.png)  


**提示:** 可以将项目中用到的所有第三方服务单独放到一个三方服务模块中去.(也就是再创建一个新的模块)  

1.[访问OSS官方文档](https://help.aliyun.com/zh/oss/)  
实践教程->网站与移动应用->Web端直传实践->服务端签名直传并设置上传回调->[Java](https://help.aliyun.com/zh/oss/use-cases/java-1)

2.根据文档内容进行学习使用  

3.主要关注下面CallbackServer类的doGet方法.

4.因为文档中使用的是servlet,所以我们创建一个controller,模仿写出相应的方法;注意这里上传成功后还可以设置阿里云的回调URL(但是这里没有设置)  
```java

    // 设置自动注入的构造方法
    private OSS ossClient;

    @GetMapping("oss/policy")
    protected Map<String,String> policy(){
        // 阿里云账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM用户进行API访问或日常运维，请登录RAM控制台创建RAM用户。
        String accessId = "yourAccessKeyId";
        String accessKey = "yourAccessKeySecret";
        // Endpoint以华东1（杭州）为例，其它Region请按实际情况填写。
        String endpoint = "oss-cn-hangzhou.aliyuncs.com";
        // 填写Bucket名称，例如examplebucket。
        String bucket = "examplebucket";
        // 填写Host地址，格式为https://bucketname.endpoint。
        String host = "https://examplebucket.oss-cn-hangzhou.aliyuncs.com";
        // 设置上传回调URL，即回调服务器地址，用于处理应用服务器与OSS之间的通信。OSS会在文件上传完成后，把文件上传信息通过此回调URL发送给应用服务器。
        String callbackUrl = "https://192.168.0.0:8888";
        // 设置上传到OSS文件的前缀，可置空此项。置空后，文件将上传至Bucket的根目录下。
        String dir = "exampledir/";
        
        // 创建ossClient实例。
        OSS ossClient = new OSSClientBuilder().build(endpoint, accessId, accessKey);
        Map<String, String> respMap = null;
        try {
            long expireTime = 30;
            long expireEndTime = System.currentTimeMillis() + expireTime * 1000;
            Date expiration = new Date(expireEndTime);
            PolicyConditions policyConds = new PolicyConditions();
            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000);
            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);

            String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);
            byte[] binaryData = postPolicy.getBytes("utf-8");
            String encodedPolicy = BinaryUtil.toBase64String(binaryData);
            String postSignature = ossClient.calculatePostSignature(postPolicy);

            respMap = new LinkedHashMap<String, String>();
            respMap.put("accessid", accessId);
            respMap.put("policy", encodedPolicy);
            respMap.put("signature", postSignature);
            respMap.put("dir", dir);
            respMap.put("host", host);
            respMap.put("expire", String.valueOf(expireEndTime / 1000));
            // respMap.put("expire", formatISO8601Date(expiration));
        } catch (Exception e) {
            // Assert.fail(e.getMessage());
            System.out.println(e.getMessage());
        }
        return respMap;
    }
```

### 1.3 配置跨域访问  
**解释:** 因为现在交给客户端访问阿里云的OSS对象存储服务,而Vue本身又是跨域请求的,所以必须在阿里云配置跨域请求的相关设置.

1.来到阿里云的某个桶的基础设置下  
![OSS跨域请求](resourcesSelected/2.png)  

2.在下面有一个基础设置里面的跨域访问  
![跨域访问](resourcesSelected/3.png)  

参照1.2给出的java调用文档访问地址,进行跨域的配置.  


## 2.Java校验  
**目录:**  
2.1 BingResult的作用  
2.2 异常处理  

### 2.1 BindingResult的作用  
**解释:** 通过BindingResult可以获取本次校验的结果信息.  

```java
public void save(@Valid @RequestBody User user,BindingResult bindingResult){
    // 通过bindingResult可以获取本次校验的结果,用法是直接在入参里面跟上一个BindingResult对象会自动传入.
}
```

**特性:** 如果在Controller中写了BindingResult这个对象,那么参数校验失败就不会产生异常了,而是将校验结果封装到该对象中,否则参数校验失败会抛出异常.异常默认会被spring处理,所以我们要配置全局统一的参数校验失败异常捕获逻辑.该异常就是MethodArgumentNotValidException

在`@RestControllerAdvice`类中捕获相关的异常

### 2.2异常处理  
项目需要自定义异常响应码,而且是5位的需要与前端约定好;放在响应体的code字段中.  
定义一个全局的异常枚举类,需要Integer字段(代码响应码)还有String类型的字段,代表该异常码对应的提示信息.  

  

